# Eve Horizon Docs - deployment manifest
schema: eve/compose/v2
project: evdocs

registry: "eve"

x-eve:
  defaults:
    hints:
      permission_policy: auto_edit

services:
  docs:
    build:
      context: ./website
    ports: [3000]
    environment:
      NODE_ENV: production
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/api/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 10s
      timeout: 3s
      retries: 3
    x-eve:
      ingress:
        public: true
        port: 3000
        alias: docs

environments:
  staging:
    pipeline: deploy

pipelines:
  deploy:
    trigger:
      github:
        event: push
        branch: main
    steps:
      - name: build
        action: { type: build }
      - name: release
        depends_on: [build]
        action: { type: release }
      - name: deploy
        depends_on: [release]
        action: { type: deploy }

workflows:
  sync-docs:
    trigger:
      cron:
        schedule: "0 9 * * *"
    hints:
      permission_policy: auto_edit
    git:
      ref: main
      commit: auto
      push: on_success
    steps:
      - agent:
          prompt: |
            You are the eve-horizon-docs auto-sync agent.

            ## Workspace
            You are running in an Eve job. Your cwd is the evdocs project repo.
            Source access is via the GitHub API using Node.js fetch() — no clone needed.
            GITHUB_TOKEN is available as process.env.GITHUB_TOKEN for authenticated API calls.
            The worker may not have gh, curl, or jq — use Node.js for all HTTP calls.

            ## Setup
            1. Read the sync-docs skill from private-skills/sync-docs/SKILL.md
            2. Verify GitHub API access per the skill's Phase 1 instructions

            ## Execute
            3. Run the full sync workflow defined in the skill (all 5 phases)
            4. The skill will:
               - Read .sync-state.json to find the last synced commit
               - Use Node.js fetch() to call GitHub Compare API
               - Cross-reference changes with .sync-map.json
               - Update affected docs pages (human-readable documentation)
               - Fetch full source files via Contents API when patches are truncated
               - Update .sync-state.json with the new commit hash
            5. If there are no changes, report that docs are up to date
            6. If there are changes, they will be committed and pushed
               automatically by the job's git controls (commit: auto,
               push: on_success)
